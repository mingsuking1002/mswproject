# 메이플스토리 월드 (MSW) 개발 지식 베이스

> 이 문서는 MSW 개발을 위한 에이전트 전용 레퍼런스(Cheat Sheet)입니다.

## 1. 아키텍처 및 실행 제어 (Execution Space)
MSW는 **Server-Client** 모델을 따르며, 코드 실행 위치를 명확히 구분해야 합니다.

### 실행 공간 속성
함수 위에 데코레이터를 붙여 실행 위치를 지정합니다.

| 데코레이터 | 호출(Call) 위치 | 실행(Execute) 위치 | 용도 |
| :--- | :--- | :--- | :--- |
| **`[Default]`** | Server / Client | 호출한 공간 그대로 | 유틸리티 함수 |
| **`[Server]`** | Client | **Server** (RPC) | 클라이언트가 서버에 요청 (예: 물건 구매) |
| **`[ServerOnly]`** | Server | **Server** | 서버 내부 로직 (예: DB 저장, 데미지 계산) |
| **`[Client]`** | Server | **Client** (RPC) | 서버가 클라이언트에 지시 (예: 알림 메시지) |
| **`[ClientOnly]`** | Client | **Client** | 클라이언트 내부 로직 (예: UI 갱신, 이펙트) |
| **`[Multicast]`** | Server | **Server + All Clients** | 모두에게 알림 (예: 채팅, 광역 스킬) |

### 코드 예시: 서버-클라이언트 통신패턴
```lua
Component: MyGameLogic
Property:
    [Sync] 
    integer Score = 0

Method:
    -- 1. [Client] 유저가 버튼을 눌러 구매 요청
    [ClientOnly]
    void OnBuyButtonClick()
    {
        self:RequestBuyItem(1001) -- 서버 함수 호출
    }

    -- 2. [Server] 서버가 요청을 받아 처리
    [Server] 
    void RequestBuyItem(integer itemId)
    {
        -- 보안 검사 (돈이 있는지 등)
        if self:CheckMoney() then
            self.Score = self.Score + 10 -- [Sync] 프로퍼티 변경 (자동 동기화)
            self:ShowEffectToClient("Success") -- 클라이언트 함수 호출
        end
    }

    -- 3. [Client] 결과 연출
    [Client]
    void ShowEffectToClient(string type)
    {
        -- 특정 유저에게만 보낼 때는 마지막 인자로 UserId 전달 가능 (문서 참조)
        log("Effect: " .. type)
    }
```

---

## 2. 데이터 동기화 (Property Sync)
데이터의 일관성을 유지하기 위해 `[Sync]` 프로퍼티를 사용합니다.

### 핵심 규칙
1.  **Server Authority**: 데이터의 원본은 서버입니다.
2.  **Server -> Client (O)**: 서버에서 `[Sync]` 프로퍼티 값을 바꾸면, 모든 클라이언트에 자동 전파됩니다.
3.  **Client -> Server (X)**: 클라이언트에서 `[Sync]` 프로퍼티를 바꿔도 서버에 반영되지 않습니다. (로컬에서만 바뀜 -> Desync 원인)
4.  **OnSyncProperty**: 값이 동기화되는 시점을 클라이언트가 감지할 수 있습니다.

### 코드 예시: 체력바 동기화
```lua
Property:
    [Sync]
    integer HP = 100

Method:
    [ServerOnly]
    void OnTakeDamage(integer damage)
    {
        self.HP = self.HP - damage -- 서버에서 변경 -> 클라이언트로 자동 전송
    }

    [ClientOnly]
    void OnSyncProperty(string name, any value)
    {
        if name == "HP" then
            -- UI 갱신은 값이 '도착했을 때' 처리
            self:UpdateHPBarUI(value)
        end
    }
```

---

## 3. 이동 및 물리 (Rigidbody & TileMap)
메이플스토리 스타일의 2D 횡스크롤 이동을 구현합니다.

*   **RigidbodyComponent**: 물리 및 이동 담당.
    *   `IsBlockVerticalLine`: 수직벽 통과 여부 설정.
    *   `JumpForce`, `WalkSpeed`: 이동 파라미터.
*   **TileMapComponent**: 맵의 발판(Foothold) 담당.
    *   레이어(Layer)에 따라 충돌이 분리됨.

### 코드 예시: 간단한 점프력 변경
```lua
[ServerOnly]
void BuffJumpPower()
{
    -- 컴포넌트 가져오기
    local rigidbody = self.Entity.RigidbodyComponent
    if rigidbody then
        rigidbody.JumpForce = 12.0 -- 점프력 증가
    end
}
```

---

## 4. mLua 필수 문법 요약
*   **로그 출력**: `log("Message")`
*   **현재 엔티티 접근**: `self.Entity`
*   **다른 컴포넌트 접근**: `self.Entity.ComponentClassName`
*   **서비스 접근**: `_UserService`, `_DataStorageService` 등 (`_` 접두어 사용)
*   **Nil 체크**: `if value == nil then ... end`
*   **Table 순회**: `for key, value in pairs(myTable) do ... end`
