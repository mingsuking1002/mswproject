# 메이플스토리 월드 (MSW) 슈프림 지식 베이스

> **문서 버전**: 3.0 (Mastery)
> **목적**: MSW 엔진의 모든 측면(아키텍처, 스크립팅, 최적화, 리소스, 데이터)을 마스터하기 위한 통합 레퍼런스입니다.

---

## 1. 핵심 아키텍처 및 최적화 (Effective MSW)

### 1.1 실행 제어와 네트워크 비용
*   **패킷 홍수 (Packet Flooding)**: 매 프레임(`OnUpdate`)마다 다른 실행 공간(`Client` <-> `Server`)을 호출하면 발생. 서버 틱(Tick) 저하의 주원인.
*   **TargetUserSync**: 특정 유저에게만 응답을 보낼 때 반드시 사용.
    ```lua
    -- [Server]
    self:ResponseToClient(userId, data) 
    
    -- [Client]
    -- 마지막 인자 userId는 생략됨. 자동으로 해당 유저에게만 전송.
    void ResponseToClient(string data) { ... }
    ```

### 1.2 Update 문 최적화 규칙
1.  **동기화 프로퍼티 금지**: `OnUpdate`에서 `[Sync]` 프로퍼티 변경 절대 금지 (N*N 트래픽 발생).
2.  **Wait 금지**: `OnUpdate` 내 `wait()` 사용 시 Update 객체가 누적되어 메모리 누수 및 로직 꼬임 발생.
3.  **_T 프로퍼티 활용**: 동기화가 필요 없는 임시 변수는 `self._T.variable` 사용 (빠름, 공간 내 공유).

### 1.3 프로파일링 지표
*   **FPS (Client)**: 30 이상 권장. UI 엔티티 과다 시 저하 가능성.
*   **Tick (Server)**: 서버 연산 속도. 30 이상 권장. 10 이하 시 렉 발생.
*   **ExecuteSpaceCount**: 공간 간 호출 횟수. 급증 시 패팃 홍수 의심.

---

## 2. 스크립팅 심화 (Advanced Scripting)

### 2.1 프로퍼티 시스템
| 타입 | 설명 | 특징 |
| :--- | :--- | :--- |
| **SyncTable<K,V>** | 동기화 가능한 테이블 | `next()` 불가. 일반 테이블보다 느림. |
| **EntityRef** | 엔티티 참조 (안전) | 맵 이동 후에도 참조 유지 (느림). |
| **ComponentRef** | 컴포넌트 참조 (안전) | 맵 이동 후에도 참조 유지. |
| **_T** | 비동기화 임시 프로퍼티 | 함수 내 `self._T.name`으로 즉시 생성. |

### 2.2 함수 (Method)
*   **호출 규약**:
    *   인스턴스 함수: `self:MethodName()` (콜론 사용)
    *   정적(Static) 함수: `Vector2.Distance()` (점 사용)
*   **오버라이드**: `OnInitialize` 등 라이프사이클 함수는 시스템이 호출.

---

## 3. 월드 구성 및 맵 (Map & Layers)

### 3.1 맵 모드
1.  **MapleTileMap**: 횡스크롤 (Rigidbody).
2.  **RectTileMap**: 탑뷰 (KinematicBody). `SetTile`로 스크립트 동적 타일 교체 가능.
3.  **SideViewRectTileMap**: 렉트타일 기반 횡스크롤.

### 3.2 레이어 우선순위 (Rendering Order)
높은 순서대로 앞에 출력:
1.  **Map Layer** (가장 큰 그룹)
2.  **SortingLayer** (설정된 이름)
3.  **OrderInLayer** (숫자, 높을수록 앞)
4.  **Z Position** (Transform)

### 3.3 로프와 사다리
*   **ClimbableComponent**: 등반 로직 담당.
*   **ClimbableSpriteRendererComponent**: 줄 이미지 렌더링.
*   **설정**: `IsUseDefaultObjectBoxSize`를 `false`로 하고 `Collider`를 직접 수정하여 잡는 범위 조절 가능.

---

## 4. 데이터 시스템 (Advanced DataStorage)

### 4.1 안정성 패턴
*   **실패 예외처리**: `GetAndWait` 반환 `errorCode` 확인 필수 (0이 아니면 실패).
*   **JSON 직렬화**: 여러 데이터를 한 키에 저장하여 Credit 절약.
    ```lua
    local data = { mp = 100, exp = 5000 }
    local jsonStr = _HttpService:JSONEncode(data)
    storage:SetAsync("SaveData", jsonStr, callback)
    ```
*   **저장 타이밍**:
    1.  중요 데이터 변경 시 (최소화)
    2.  주기적 자동 저장 (TimerService)
    3.  **UserLeaveEvent**: 유저 퇴장 시 (OnEndPlay보다 안전).

### 4.2 배치 처리 (Batch)
*   `BatchSetAsync`, `BatchGetAsync`: 여러 키를 한 번에 처리하여 API 호출 횟수 절약.

---

## 5. 리소스 및 연출 (Visuals)

### 5.1 아바타 커스텀
*   **ZMap**: 아바타의 레이어 순서(Body < Clothes < Weapon 등)를 정의하는 맵.
*   **ActionState**:
    *   `ActionStateChangedEvent`: 가장 세밀한 제어 (프레임 단위).
    *   `BodyActionStateChangeEvent`: 무기 타입에 맞춰 자동 보정 (편리).

### 5.2 애니메이션
*   **AnimationClipEditor**: 스프라이트를 조합하여 애니메이션 생성.
*   **FrameEvent**: 특정 프레임(예: 공격 모션의 타격 시점)에 이벤트 발생 가능.
    *   `SpriteAnimPlayerChangeFrameEvent` 감지 후 로직 처리.

---

## 6. 주요 서비스 API 목록
*   **InputService**: 키보드/마우스 입력 (`HandleKeyDownEvent`).
*   **SoundService**: 배경음, 효과음 재생.
*   **EffectService**: 이펙트 재생 (`PlayEffectAttached` 등).
*   **TeleportService**: 맵 이동 처리.
*   **UserService**: 유저 엔티티 조회 및 강제 퇴장 (`KickUser`).
