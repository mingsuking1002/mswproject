# 🟢 완료
# SPEC_RankingSystem — 랭킹(리더보드) 시스템

## 1. 개요

| 항목 | 내용 |
|---|---|
| **Component Name** | `RankingComponent`, `RankingUIComponent` |
| **기능 요약** | 타임어택/무한모드 이중 리더보드, 서버 저장, Top 100 + 내 순위 |
| **기획서 참조** | `기획서/1.핵심 시스템/[시스템] 랭킹 시스템 기획.md` |

### 핵심 동작
- 게임 결과 화면에서 **신기록일 때만** 서버에 점수 전송
- 랭킹 창에서 **상위 1~100위** + **내 순위** 표시
- 두 가지 모드: **타임어택** (빠를수록 1등) / **무한모드** (처치수 많을수록 1등)

---

## 2. Execution Space

| 처리 단계 | 실행 공간 | 설명 |
|---|---|---|
| 기록 비교 (신기록 체크) | `[server only]` | 결과 화면 출력 시점 |
| 서버에 점수 전송 | `[server only]` | `_LeaderBoardService` (MSW 내장) |
| 랭킹 데이터 요청 | `[client]` → `[server]` | 랭킹 창 오픈 시 |
| 랭킹 UI 표시 | `[client only]` | 리스트 렌더링 |

---

## 3. Properties

### RankingComponent

| Property Name | Type | Sync | Default | 설명 |
|---|---|---|---|---|
| `TimeAttackBestTime` | `number` | `None` | `-1` | 로컬 최고 기록 (타임어택) |
| `InfiniteModeBestKills` | `integer` | `None` | `0` | 로컬 최고 기록 (무한모드 처치수) |

### RankingUIComponent

| Property Name | Type | Sync | Default | 설명 |
|---|---|---|---|---|
| `CurrentTab` | `integer` | `None` | `1` | 현재 탭 (1=타임어택, 2=무한모드) |
| `DisplayCount` | `integer` | `None` | `100` | 표시할 최대 순위 수 |

---

## 4. 랭킹 모드 사양

| 항목 | 모드 A (타임어택) | 모드 B (무한모드) |
|---|---|---|
| **기준** | 클리어 시간 | 몬스터 처치 수 |
| **정렬** | 오름차순 (빠를수록 1등) | 내림차순 (많을수록 1등) |
| **데이터 형식** | `MM:SS.ms` | `Integer` |
| **갱신 조건** | 기존보다 빠를 때만 | 기존보다 많을 때만 |
| **동점 처리** | 먼저 달성한 유저 우선 | 먼저 달성한 유저 우선 |
| **치트 방지** | 물리적 불가능 시간 검증 | 비정상 처치수 검증 |

---

## 5. 사용 서비스 & API

| 서비스/API | 용도 |
|---|---|
| `_LeaderBoardService` | MSW 내장 리더보드 (점수 등록/조회) |
| `_DataStorageService` | 로컬 개인 최고 기록 저장 |
| `_UserService` | 유저 닉네임 조회 |
| UI 시스템 | 랭킹 팝업, 탭, 리스트 렌더링 |

---

## 6. 로직 흐름

### 6-1. 기록 제출 (결과 화면 시점)
1. 게임 클리어/종료 → 결과 화면 출력
2. 현재 기록과 로컬 **개인 최고 기록** 비교
3. **신기록일 때만** `_LeaderBoardService`에 점수 전송
4. 로컬 최고 기록 갱신 (`_DataStorageService`)

### 6-2. 랭킹 조회 (랭킹 창 오픈 시)
1. `_LeaderBoardService`에서 **상위 1~100위** 데이터 요청
2. **내 순위(My Rank)** 별도 요청
3. 클라이언트에서 리스트 렌더링

### 6-3. UI 구조
- **탭:** 상단에 [타임어택] / [무한모드] 버튼 — 탭 전환
- **리스트 항목 (각 행):**
  - 순위 (1~3위: 메달 아이콘)
  - 닉네임
  - 기록 (타임어택: `02:14.55`, 무한모드: `15,400 점`)
  - 갱신일 (`YYYY.MM.DD`)
- **내 순위:** 리스트 최하단 고정 (스크롤 무관)
  - 100위 밖이면 순위 칸에 `'-'` 또는 `'순위 밖'` 표시

### 6-4. 치트 방지
- 서버에서 물리적으로 불가능한 기록 필터링 (예: 3초 클리어)
- 비정상 처치수 검증 (예: 30분에 3억 마리)
- 검증 기준은 Property로 설정 가능하게 → 밸런싱 후 조정

---

## 7. 연동 컴포넌트

| 컴포넌트 | 연동 방식 | 설명 |
|---|---|---|
| `SpeedrunTimerComponent` | `ElapsedTime` 수신 | 타임어택 기록 제출 |
| `GameManagerComponent` | 클리어/결과 이벤트 | 결과 화면에서 기록 제출 트리거 |
| `HUDComponent` | UI 호출 | 랭킹 팝업 열기/닫기 |

---

## 8. 주의 사항

- [ ] 게임 플레이 중에는 서버 저장 **안 함** (부하 방지) — 결과 화면에서만
- [ ] MSW의 `_LeaderBoardService` API 확인 필요 → Codex가 먼저 API 스펙 조회
- [ ] 동점자 처리: 먼저 달성한 유저 우선 (서버 타임스탬프 기준)
- [ ] 랭킹 UI 상세 디자인은 별도 UI 기획서 필요 → 최소 기능 먼저

---

## 9. Codex 구현 체크리스트

- [ ] `@Component` 어트리뷰트로 시작
- [ ] 밸런스 수치 전부 `property`로 선언
- [ ] `[server only]` / `[client only]` 분리
- [ ] `nil` 체크, `isValid` 방어 코드
- [ ] `기획서/4.부록/Code_Documentation.md` 업데이트
- [ ] 완료 후 상태 `🟢 완료`로 변경

---

## 메타 정보

| 항목 | 내용 |
|---|---|
| **작성자** | Antigravity (TD) |
| **담당자** | Codex |
| **작성일** | 2026-02-18 |
| **상태** | 🟡 대기중 |
