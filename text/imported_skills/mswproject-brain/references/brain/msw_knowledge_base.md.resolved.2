# 메이플스토리 월드 (MSW) 마스터 지식 베이스

> 문서 버전: 2.0 (Deep Dive 반영)
> 이 문서는 MSW 개발의 모든 측면(아키텍처, 최적화, 애니메이션, 데이터 등)을 포괄하는 상세 레퍼런스입니다.

---

## 1. 아키텍처 및 실행 제어 (Execution & Network)

### SERVER vs CLIENT
*   **Server**: 월드의 '단일 진실(Source of Truth)'. 로직 판정, 데이터 저장, 보안 검증.
*   **Client**: 유저의 단말기. 화면 렌더링, 입력 감지, 연출.

### 함수 데코레이터와 실행 공간
| 데코레이터 | 설명 | 주의사항 |
| :--- | :--- | :--- |
| **`[Server]`** | Client에서 호출 -> Server에서 실행 | RPC 비용 발생 (네트워크). 빈번한 호출 금지. |
| **`[ServerOnly]`** | Server 전용 함수 | Client에서 호출 시 무시됨. |
| **`[Client]`** | Server에서 호출 -> Client에서 실행 | **특정 유저에게만 보내기 가능** (마지막 인자 `targetUserId` 자동 처리). |
| **`[ClientOnly]`** | Client 전용 함수 | UI, 입력 처리, 로컬 애니메이션 제어. |

### 최적화 (Effective MSW)
1.  **OnUpdate 주의**: `Any` 동기화 프로퍼티 변경 금지. `wait()` 사용 금지 (Update 객체 누적됨).
2.  **TargetUserSync**: `[Client]` 함수 호출 시 특정 유저에게만 응답(`Response`)하여 트래픽 절약.
    ```lua
    [Client] void Response(int itemId) { ... } -- 자동 userId 파라미터 활용
    -- 호출 시: self:Response(itemId, userId)
    ```
3.  **isvalid() 사용**: 엔티티 삭제 요청 후 완전히 사라지기까지 딜레이가 있음. `if isvalid(entity) then ... end` 필수.
4.  **TimerService**: `wait()` 대신 `_TimerService:SetTimerOnce`를 사용하여 병렬 처리 권장.

---

## 2. 생명주기 (Lifecycle)

| 함수 | 호출 시점 | 비고 |
| :--- | :--- | :--- |
| **`OnInitialize`** | 생성 직후 | 타 컴포넌트/엔티티 참조 **위험** (nil 가능성). |
| **`OnBeginPlay`** | 초기화 완료 후 | 타 컴포넌트 참조 **안전**. 로직 시작점. |
| **`OnUpdate`** | 매 프레임 | `delta` 시간 활용. 무거운 연산 금지. |
| **`OnSyncProperty`** | `[Sync]` 값 수신 시 | **ClientOnly**. UI 갱신에 최적. |
| **`OnMapEnter`** | 맵 입장/생성 시 | 맵 이동 시마다 초기화 필요할 때 사용. |
| **`OnDestroy`** | 삭제 시 | 메모리 해제. |

---

## 3. 아바타와 애니메이션 (Avatar Control)

### 제어 방법 비교
1.  **ActionStateChangedEvent** (세밀함)
    *   Body(몸)와 Parts(장비) 애니메이션을 각각 지정 가능.
    *   `SendEvent`: `self.Entity.AvatarRendererComponent:GetBodyEntity():SendEvent(event)`
2.  **BodyActionStateChangeEvent** (편리함)
    *   `MapleAvatarBodyActionState` 프리셋(Stand, Walk, Attack 등) 사용.
    *   무기 타입에 따라 애니메이션 자동 보정.
3.  **ActionSheet + StateComponent** (자동화)
    *   `StateComponent.CurrentStateName`만 바꾸면 `ActionSheet` 매핑에 따라 자동 변경.

### 코드 예시: 걷기 애니메이션 강제 재생
```lua
[ClientOnly]
void PlayWalkAnim()
{
    -- BodyActionStateChangeEvent 사용 (권장)
    local event = BodyActionStateChangeEvent()
    event.ActionState = MapleAvatarBodyActionState.Walk
    event.needResetAction = true
    self.Entity:SendEvent(event)
}
```

---

## 4. 데이터 저장소 (DataStorage)

### 저장소 종류
*   **GlobalDataStorage**: 월드 전체 공유.
*   **UserDataStorage**: 유저 개인 데이터 (`userId` 키).
*   **SortableDataStorage**: 랭킹용 (Int 값만 저장 가능, 정렬 지원).

### 사용 패턴 (비동기 vs 동기)
*   **~AndWait** (동기): 로직을 멈추고 기다림. 간단하지만 `OnUpdate`에서 사용 금지.
*   **~Async** (비동기): 콜백 함수로 처리. 성능상 유리.

### 코드 예시: 데이터 저장 (Batch)
```lua
[ServerOnly]
void SaveUserData(string userId)
{
    local storage = _DataStorageService:GetUserDataStorage(userId)
    local data = { Level = "10", Exp = "500" } -- 문자열만 가능 (table은 JSON 변환 필요)
    storage:BatchSetAsync(data, function(code, keys)
        if code == 0 then log("Saved!") end
    end)
}
```

---

## 5. UI 시스템

### 기본 구조
*   UI 엔티티는 `Screen` 공간에 존재.
*   `UITransformComponent`: 위치(Anchor) 결정.
*   `SpriteGUIRendererComponent`: 이미지 출력.

### 입력 처리
*   **ButtonComponent**: `ButtonClickEvent` 사용.
*   **TextInputComponent**: `TextInputValuesChangeEvent` 사용.
*   **이벤트 연결**:
    ```lua
    self.Entity:ConnectEvent(ButtonClickEvent, function() ... end)
    ```

---

## 6. 물리와 이동 (Movement)
*   **RigidbodyComponent**: 물리 연산. `LayerSettingType`으로 사다리/로프 동작 결정.
*   **TileMapComponent**: 충돌 레이어 설정 (`IsVerticalLine` 등).
*   **팁**: 메이플 특유의 '착 감기는' 이동감을 위해 `Rigidbody`의 파라미터(`WalkDrag` 등) 미세 조정 필요.

---

## 7. 주요 서비스 (Service API)
*   **`_EntityService`**: 엔티티 찾기 (`GetEntity`, `GetEntityByPath`).
*   **`_UserService`**: 유저 검색, 로컬 플레이어 접근 (`LocalPlayer`).
*   **`_DataStorageService`**: DB 접근.
*   **`_TimerService`**: 타이머 설정 (`SetTimerOnce`, `SetTimerRepeat`).
*   **`_TeleportService`**: 유저를 다른 맵/위치로 이동.
