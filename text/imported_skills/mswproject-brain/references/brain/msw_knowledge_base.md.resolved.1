# 메이플스토리 월드 (MSW) 개발 지식 베이스

> 이 문서는 MSW 개발을 위한 에이전트 전용 레퍼런스 및 치트시트입니다. 최신 문서(`postId=472` 기반)를 통합하여 업데이트했습니다.

## 1. 아키텍처 및 실행 제어 (Execution Space: `postId=210`)
MSW는 **Server-Client** 모델을 따르며, 코드 실행 위치를 명확히 구분해야 합니다.

### 실행 공간 속성
| 데코레이터 | 호출(Call) 위치 | 실행(Execute) 위치 | 용도 |
| :--- | :--- | :--- | :--- |
| **`[Server]`** | Client | **Server** (RPC) | 클라이언트 -> 서버 요청 (예: 물건 구매) |
| **`[ServerOnly]`** | Server | **Server** | 서버 내부 로직 (DB 저장, 보안 로직) |
| **`[Client]`** | Server | **Client** (RPC) | 서버 -> 클라이언트 지시 (예: 알림, UI 갱신) |
| **`[ClientOnly]`** | Client | **Client** | 클라이언트 내부 로직 (입력 처리, 연출) |
| **`[Multicast]`** | Server | **Server + All Clients** | 모두에게 알림 (채팅, 광역 스킬) |

---

## 2. 생명주기 (Lifecycle: `postId=163`)
함수의 호출 순서를 이해해야 초기화 오류를 방지할 수 있습니다.

1.  **`OnInitialize`**: 엔티티 생성 직후 1회. (다른 컴포넌트는 아직 없을 수 있음, 참조 주의).
2.  **`OnBeginPlay`**: 모든 컴포넌트 로드 완료 후 1회. 본격적인 로직 시작. (타 엔티티/컴포넌트 참조 안전).
3.  **`OnUpdate(delta)`**: 매 프레임 호출. `delta`(초 단위 시간 차)를 이용해 이동/타이머 구현.
4.  **`OnMapEnter(enteredMap)`**: 맵 입장 시마다 호출. (플레이어가 맵 이동할 때 유용).
5.  **`OnEndPlay`**: 엔티티 제거 직전.
6.  **`OnDestroy`**: 엔티티 메모리 해제 시.

---

## 3. 데이터 동기화 (Sync: `postId=208`)
*   **[Sync] 프로퍼티**: 서버에서 값을 바꾸면 클라이언트에 자동 전파됩니다.
*   **단방향성**: Client에서 `[Sync]` 프로퍼티를 바꿔도 Server에는 반영되지 않습니다.
*   **`OnSyncProperty(name, value)`**: 값이 클라이언트에 도착했을 때 호출됩니다. UI 갱신은 여기서 처리하는 것이 가장 정확합니다.

---

## 4. 데이터 저장 (DataStorage: `postId=692`)
게임 데이터(레벨, 돈, 아이템)를 영구 저장합니다. `_DataStorageService`를 사용합니다.

*   **GlobalDataStorage**: 월드 전역 공유.
*   **UserDataStorage**: 유저 개인 저장소 (`userId` 필요).
*   **SortableDataStorage**: 정수(Int) 저장 및 랭킹 정렬 가능.

#### 저장/불러오기 예시
```lua
-- [저장] ServerOnly
local storage = _DataStorageService:GetGlobalDataStorage("MyGameData")
storage:SetAndWait("HighScore", "100") -- 값은 문자열로 저장

-- [불러오기] ServerOnly
local errorCode, value = storage:GetAndWait("HighScore")
if errorCode == 0 then
    log("Loaded: " .. value)
end
```
*   `AndWait` (동기): 완료될 때까지 멈춤.
*   `SetAsync` (비동기): 콜백 함수로 결과 처리.

---

## 5. UI 시스템 (UI Component: `postId=744`)
UI는 `Screen` 공간에 존재하며 `UITransformComponent`를 가집니다.

*   **ButtonComponent**: 클릭 입력을 받음.
*   **Code Example (버튼 클릭)**:
    ```lua
    -- UI 엔티티에 컴포넌트 추가 후 스크립트 연결
    Method:
    [ClientOnly]
    void OnBeginPlay()
    {
        -- 버튼 이벤트를 연결합니다.
        self.Entity:ConnectEvent(ButtonClickEvent, function(event)
            log("Button Clicked!")
            self:OnClickAction()
        end)
    }
    
    [ClientOnly]
    void OnClickAction()
    {
        -- 서버에 요청을 보냅니다.
        self:RequestServerLogic()
    }
    ```

---

## 6. 이동 및 물리 (`postId=750`)
*   **RigidbodyComponent**: 물리 엔진 포함.
*   **TileMapComponent**: 충돌체(발판). `IsBlockVerticalLine` 등의 설정으로 통과 여부 결정.
*   **메이플스토리 이동**: `LayerSettingType`을 `All`로 두면 메이플 고유의 사다리/로프 로직을 따릅니다.
